<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <link rel="shortcut icon" href="./src/Bản sao của tapchat (1).png" type="image/x-icon">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="/src/style.css">
    <link rel="stylesheet" href="/src/tailwindcss-colors.css">

</head>
<body>
<!-- Login -->
<div class="py-3 py-md-5" id="login-page" style="height: 100vh; background: url('/src/Light Blue Colorful School Zoom Virtual Background (2).png')">
    <div class="container" style="margin-top: 100px;">
        <div class="row justify-content-center align-items-center">
            <div class="col-12 col-md-11 col-lg-8 col-xl-7 col-xxl-4">
                <div class="p-4 p-md-5" style="background: rgb(64, 64, 64); box-shadow: rgba(0, 0, 0, 0.5) 0px 5px 15px; border-radius: 20px">
                    <div class="row mb-5">
                        <div class="col-12">
                            <div class="text-center">
                                <a href="#!">
                                    <img src="/src/tapchat (2) (1).png" alt="BootstrapBrain Logo" width="70%" height="70%">
                                </a>
                            </div>
                        </div>
                    </div>
                    <form id="login-form">
                        <div class="row gy-3 gy-md-4 overflow-hidden"  style="margin-top: -20px;">
                            <div class="col-12">
                                <label for="username" class="form-label text-white">Username <span class="text-danger">*</span></label>
                                <div class="input-group">
                        <span class="input-group-text">
                            <i class='bx bx-envelope'></i>
                        </span>
                                    <input type="text" class="form-control" name="username" id="username" required>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="password" class="form-label text-white">Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                        <span class="input-group-text">
                            <i class='bx bxs-key' ></i>
                        </span>
                                    <input type="password" class="form-control" name="password" id="password" required>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-grid">
                                    <button class="btn btn-primary btn-lg" type="submit">Đăng Nhập</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="row">
                        <div class="col-12">
                            <hr class="mt-5 mb-4 border-secondary-subtle text-white">
                            <div class="d-flex gap-2 gap-md-4 flex-column flex-md-row justify-content-md-center">
                                <a href="register.html" class="link-secondary text-decoration-none">Tạo mới tài khoản</a>
                                <a href="#!" class="link-secondary text-decoration-none">Quên mật khẩu</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Chat -->
<section class=" chat-container hidden" id="chat-page">
    <div class="chat-container">
        <!-- Sidebar -->
        <aside class="chat-sidebar">
            <a href="#" class="chat-sidebar-logo">
                <img src="src/Bản sao của tapchat (1).png" alt="">
            </a>
            <ul class="chat-sidebar-menu">
                <li class="active"><a href="#" data-title="Chat"><i class='bx bx-chat'></i></a></li>
                <li><a href="#" data-title="Setting"><i class='bx bx-cog'></i></a></li>
                <li><a href="#" data-title="Dark/Light" id="darkModeToggle" onclick="toggleDarkMode()"><i class='bx bx-moon'></i></a></li>
                <li class="chat-sidebar-profile">
                    <button type="button" class="chat-sidebar-profile-toggle">
                        <img src="src/social-media-chatting-online-blank-profile-picture-head-and-body-icon-people-standing-icon-grey-background-free-vector.jpg" alt="">
                    </button>
                    <ul class="chat-sidebar-profile-dropdown">
                        <li><a href="#" data-bs-toggle="modal" data-bs-target="#exampleModal"><i class="ri-user-line"></i> Profile</a></li>
                        <li><a href="#" id="logoutBtn"><i class="ri-logout-box-line"></i> Logout</a></li>
                    </ul>
                </li>
            </ul>
        </aside>
        <!-- Sidebar -->
        <!--  Content -->
        <div class="chat-content">
            <!--  Content side -->
            <div class="content-sidebar">
                <div class="content-sidebar-flex d-flex" style="justify-content: space-between; align-items:center">
                    <div class="content-sidebar-title">Chat</div>
                </div>
                <form action="" class="content-sidebar-form">
                    <input type="search" class="content-sidebar-input" placeholder="Tìm kiếm...">
                    <button type="submit" class="content-sidebar-submit"><i class="ri-search-line"></i></button>

                </form>
                <div class="content-sidebar-btn-add d-flex mt-3" style="margin-left: 15px; align-items:center;">
                    <button data-title="friend" class="content-sidebar-btn">
                        <i class="ri-user-add-line"></i>
                    </button>
                    <button data-title="group" class="content-sidebar-btn" onclick="showGroupForm()">
                        <i class="ri-group-line"></i>
                    </button>
                </div>
                <div class="content-messages">
                    <ul class="content-messages-list" id="connectedUsers">
                        <li class="content-message-title"><span>Message</span></li>
                    </ul>
                    <!--                    <ul id="connectedUsersList" class="connected-users-list"></ul>-->
                    <!--                    <ul id="connectedGroupList" class="connected-users-list"></ul>-->
                </div>

                <div id="groupFormPopup" class="popup">
                    <div class="popup-content">
                        <span class="close-btn" onclick="closeGroupForm()">&times;</span>
                        <h2>Create Group</h2>
                        <input type="text" id="groupName" placeholder="Group Name" class="input-field">
                        <h3>Select Members</h3>
                        <input type="text" id="searchUser" placeholder="Search User" onkeyup="searchUser()" class="input-field">
                        <div id="userList" class="user-list"></div>
                        <button onclick="createGroupHandler()" class="create-btn">Create Group</button>
                    </div>
                </div>



                <div id="groupList" class="group-list"></div> <!-- Thêm phần tử này -->

            </div>
            <!-- Content side -->
            <!--  Conversation -->
            <!--            <div class="conversation conversation-default active">-->
            <!--                <i class="ri-chat-3-line"></i>-->
            <!--                <p>Select chat and view conversation!</p>-->
            <!--        </div>-->
            <div class="conversation active">
                <div class="conversation-top">
                    <button type="button" class="conversation-back"><i class="ri-arrow-left-line"></i></button>
                    <div class="conversation-user">
                        <img class="conversation-user-image" src="src/social-media-chatting-online-blank-profile-picture-head-and-body-icon-people-standing-icon-grey-background-free-vector.jpg" alt="">
                        <div>
                            <div class="conversation-user-name"></div>
                            <div class="conversation-user-status online">online</div>
                        </div>
                    </div>
                    <div class="conversation-buttons">
                        <button type="button"><i class="ri-search-line"></i></button>
                        <button type="button"><i class="ri-phone-fill"></i></button>
                        <button type="button" id="videoCallButton"><i class="ri-vidicon-line"></i></button>
                        <button type="button"><i class="ri-more-2-fill"></i></button>
                    </div>
                </div>
                <div class="conversation-main chat-area">
                    <ul class="conversation-wrapper chat-area" id="chat-messages">
                        <div class="coversation-divider"><span>Today</span></div>
                    </ul>
                </div>
                <form class="conversation-form" id="messageForm" name="messageForm" class="hidden">
                    <!--                    <button type="button" class="conversation-form-button"><i class="ri-emotion-line"></i></button>-->
                    <button type="button" class="conversation-form-button" id="attachmentButton">
                        <i class="ri-attachment-line"></i>
                    </button>
                    <input type="file" id="fileInput" style="display: none;" />

                    <div class="conversation-form-group">
                        <input autocomplete="off" type="text" id="message" class="conversation-form-input" rows="1" placeholder="Type your message..."></input>
                        <button type="button" class="conversation-form-record"><i class="ri-mic-line"></i></button>
                    </div>
                    <button type="submit" class="conversation-form-button conversation-form-submit"><i class='bx bx-send' ></i></button>
                </form>
            </div>
            <!--  Conversation -->
        </div>
        <!--  Content -->
        <!--  Video Call  -->
        <div class="video-container" style="display:none;">
            <video id="localVideo" autoplay muted></video>
            <video id="remoteVideo" autoplay></video>
            <button id="startCall">Start Call</button>
            <button id="stopCall" disabled>Stop Call</button>
        </div>
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="update-form">
                        <div class="row gy-3 gy-md-4 overflow-hidden" style="margin-top: -20px;">
                            <div class="col-12">
                                <label for="username2" class="form-label">Username <span class="text-danger">*</span></label>
                                <div class="input-group">
                                <span class="input-group-text">
                                    <i class='bx bx-user'></i>
                                </span>
                                    <input type="text" class="form-control" name="username" id="username2" readonly style="background: transparent;">
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                                <div class="input-group">
                                <span class="input-group-text">
                                    <i class='bx bx-tag'></i>
                                </span>
                                    <input type="text" class="form-control" name="name" id="name">
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <div class="input-group">
                                <span class="input-group-text">
                                    <i class='bx bx-envelope'></i>
                                </span>
                                    <input type="email" class="form-control" name="email" id="email">
                                </div>
                            </div>
                            <input type="text" class="form-control" name="username" hidden  id="username1">
                            <div class="col-12" id="currentpassword1" hidden>
                                <label for="currentpassword" class="form-label">CurrentPassword <span class="text-danger">*</span></label>
                                <div class="input-group">
                                <span class="input-group-text">
                                    <i class='bx bxs-key'></i>
                                </span>
                                    <input type="password" class="form-control" name="currentpassword"  id="currentpassword">
                                </div>
                            </div>
                            <div class="col-12" id="newpassword1"  hidden>
                                <label for="newpassword" class="form-label">NewPassword <span class="text-danger">*</span></label>
                                <div class="input-group">
                                <span class="input-group-text">
                                    <i class='bx bxs-key'></i>
                                </span>
                                    <input type="password" class="form-control" name="newpassword" id="newpassword">
                                </div>
                            </div>
                            <div class="col-12" id="comfirmpassword1"  hidden>
                                <label for="comfirmpassword" class="form-label">ConfirmPasword <span class="text-danger">*</span></label>
                                <div class="input-group">
                                <span class="input-group-text">
                                    <i class='bx bxs-key'></i>
                                </span>
                                    <input type="password" class="form-control" name="comfirmpassword" id="comfirmpassword">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="changepasswordBtn" style="margin-left: 0">Change Password</button>
                    <button type="button" class="btn btn-primary" id="savepasswordBtn" hidden style="margin-left: 0">Save Change Password</button>

                    <button type="button" class="btn btn-secondary" id="cancelchangepasswordBtn" hidden style="margin-left: 0">Cancel</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChanges">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Chat -->

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
></script>
<script>
    $(document).ready(function() {
          $("#logoutBtn").click(function(e) {
              e.preventDefault();

              fetch("http://localhost:8088/api/v1/auth/logout", {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json"
                  },
              })
              .then(response => {
                  if (!response.ok) {
                      throw new Error("Logout failed");
                  }
                  // Xóa token từ localStorage
                  localStorage.removeItem("token");
                  console.log("Token removed from localStorage");
                   localStorage.removeItem("username");
                    console.log("Username removed from localStorage");
                  window.location.href = "/login.html";
              })
              .catch(error => {
                  console.error("Logout error:", error);
                  alert("Logout failed");
              });
          });
      });

   $(document).ready(function() {
   $('#exampleModal').on('show.bs.modal', function(event) {
       var button = $(event.relatedTarget); // Button that triggered the modal
       var username = localStorage.getItem("username"); // Lấy username từ localStorage

       // Lấy thông tin người dùng và gán vào form
       fetch(`http://localhost:8088/api/v1/auth/user/${username}`)
           .then(response => response.json())
           .then(data => {
               $('#username2').val(data.username);
               $('#username1').val(data.username);
               $('#name').val(data.name);
               $('#email').val(data.email);
           })
           .catch(error => console.error("Error fetching user data:", error));
   });

   $("#saveChanges").click(function(e) {
   e.preventDefault();

   var formData = {
       username: $("#username2").val(),
       name: $("#name").val(),
       email: $("#email").val(),
   };

   fetch("http://localhost:8088/api/v1/auth/update", {
       method: "POST",
       headers: {
           "Content-Type": "application/json"
       },
       body: JSON.stringify(formData)
   })
   .then(response => {
       if (!response.ok) {
       }
       return response.json();
   })
   .then(data => {
       console.log("User updated successfully:", data);
       alert("User updated successfully");

       // Hide the modal by removing classes and attributes
       $('#exampleModal').removeClass('show');
       $('.modal-backdrop').remove();
       $('#exampleModal').attr('aria-hidden', 'true').css('display', 'none');

       // Clear form fields if needed
       $('#register-form')[0].reset();
   })
   .catch(error => {
       console.error("Update error:", error);
       alert("Update failed");
   });
});

$("#savepasswordBtn").click(function(e) {
   e.preventDefault();

   var formData = {
       username: $("#username1").val(),
       currentPassword: $("#currentpassword").val(),
       newPassword: $("#newpassword").val(),
       confirmPassword: $("#comfirmpassword").val()
   };

   // Kiểm tra xác nhận mật khẩu mới
   if (formData.newPassword !== formData.confirmPassword) {
       alert("New password and confirm password do not match");
       return;
   }

   fetch("http://localhost:8088/api/v1/auth/change-password", {
       method: "POST",
       headers: {
           "Content-Type": "application/json"
       },
       body: JSON.stringify(formData)
   })
   .then(response => {
       if (!response.ok) {
           throw new Error("Change password failed");
       }
       return response.text();
   })
   .then(data => {
       console.log("Password changed successfully:", data);
       alert("Password changed successfully");
   })
   .catch(error => {
       console.error("Change password error:", error);
       alert("Change password failed");
   });
});

$("#changepasswordBtn").click(function() {
       // Xóa thuộc tính hidden của các trường nhập liệu
       $("#currentpassword1, #newpassword1, #comfirmpassword1").removeAttr("hidden");

       // Đổi văn bản và hành vi của các nút
       $("#changepasswordBtn").attr("hidden", true); // Ẩn nút "Change Password"
       $("#cancelchangepasswordBtn").removeAttr("hidden"); // xóa ẩn nút "cancel Change Password"
       $("#savepasswordBtn").removeAttr("hidden");
   });

   // Sự kiện khi click vào nút "Cancel"
   $("#cancelchangepasswordBtn").click(function() {
       // Ẩn các trường nhập liệu và đổi lại văn bản và hành vi của các nút
       $("#currentpassword1, #newpassword1, #comfirmpassword1").attr("hidden", true);
       $("#cancelchangepasswordBtn").attr("hidden", true);
       $("#savepasswordBtn").attr("hidden",true);
       $("#changepasswordBtn").removeAttr("hidden");


   });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
<script src="/src/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>